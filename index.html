<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Hyperverse | Professional AI Platform</title>
    
    <!-- PWA & SEO -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="assets/icon-192.png">

    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Professional Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --- 1. PROFESSIONAL CSS VARIABLES (CLEAN THEME) --- */
        :root {
            --primary: #2563eb;
            --secondary: #10b981;
            --danger: #ef4444; /* For Planes */
            --dark: #1e293b;
            --light: #f8fafc;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --font: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; scroll-behavior: smooth; }
        
        body {
            font-family: var(--font);
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        /* --- 2. NAVIGATION BAR --- */
        .navbar {
            background: var(--white);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .logo i { color: var(--secondary); margin-right: 8px; }
        
        .nav-links { display: flex; gap: 30px; list-style: none; }
        .nav-links a { text-decoration: none; color: var(--dark); font-weight: 500; transition: 0.3s; }
        .nav-links a:hover { color: var(--primary); }
        
        .cta-btn {
            background: var(--primary); color: white; padding: 10px 20px;
            border-radius: 6px; text-decoration: none; font-weight: 600;
            transition: 0.3s; border: none; cursor: pointer;
        }
        .cta-btn:hover { background: #1d4ed8; }

        /* --- 3. HERO SECTION --- */
        .hero {
            text-align: center; padding: 80px 20px;
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
        }
        .hero h1 { font-size: 3rem; margin-bottom: 20px; color: var(--dark); }
        .hero span { color: var(--primary); }
        .hero p { font-size: 1.2rem; color: #64748b; max-width: 700px; margin: 0 auto 40px; }

        /* --- 4. WEATHER SECTION --- */
        .section { padding: 60px 10%; }
        .section-title { text-align: center; margin-bottom: 40px; font-size: 2rem; color: var(--dark); }
        
        .weather-card {
            background: var(--white); padding: 30px; border-radius: 12px;
            box-shadow: var(--shadow); max-width: 500px; margin: 0 auto;
            text-align: center; border-top: 4px solid var(--secondary);
        }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input { flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        .action-btn { background: var(--dark); color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; }
        
        .weather-info { display: none; margin-top: 20px; }
        .temp-display { font-size: 3rem; font-weight: bold; color: var(--dark); }
        .ai-badge { background: #dcfce7; color: #166534; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; margin-top: 10px; display: inline-block; }

        /* --- 5. AI CHAT SECTION --- */
        .ai-container {
            background: var(--white); border-radius: 12px; box-shadow: var(--shadow);
            overflow: hidden; max-width: 800px; margin: 0 auto; display: flex; flex-direction: column;
            height: 500px; border: 1px solid #e2e8f0;
        }
        .chat-header { background: var(--primary); color: white; padding: 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .chat-box { flex: 1; padding: 20px; overflow-y: auto; background: #f1f5f9; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { padding: 12px 16px; border-radius: 8px; max-width: 80%; font-size: 0.95rem; }
        .bot { background: var(--white); align-self: flex-start; border: 1px solid #e2e8f0; }
        .user { background: var(--primary); color: white; align-self: flex-end; }
        
        .input-area { padding: 15px; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; }

        /* --- 6. MAP & FLIGHT RADAR SECTION --- */
        .map-wrapper { position: relative; height: 500px; width: 100%; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        .map-controls {
            position: absolute; top: 20px; right: 20px; z-index: 500;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .map-controls button {
            display: block; width: 100%; margin-bottom: 5px; background: var(--white);
            border: 1px solid #ddd; padding: 5px 10px; cursor: pointer; border-radius: 4px;
            font-size: 0.9rem; font-weight: 600; color: var(--dark);
        }
        .map-controls button:hover { background: #f1f5f9; }
        .map-controls button.active { background: var(--danger); color: white; border-color: var(--danger); }

        /* Flight Icon Style */
        .plane-icon {
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: transform 1s linear; /* Smooth movement */
        }

        /* --- 7. FOOTER --- */
        footer { background: var(--dark); color: white; text-align: center; padding: 40px; margin-top: 50px; }
        
        /* Mobile */
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .hero h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <!-- NAVIGATION -->
    <nav class="navbar">
        <div class="logo"><i class="fas fa-leaf"></i> CS Hyperverse</div>
        <ul class="nav-links">
            <li><a href="#weather">Weather</a></li>
            <li><a href="#ai">AI Oracle</a></li>
            <li><a href="#map">Flight Radar</a></li>
        </ul>
        <button class="cta-btn" onclick="alert('Contact Form Loading...')">Join Us</button>
    </nav>

    <!-- HERO SECTION -->
    <header class="hero">
        <h1>Global Climate & <br> <span>Atmospheric Monitoring</span></h1>
        <p>A professional platform empowering communities with real-time weather data, AI insights, and live flight tracking radar.</p>
        <div style="display:flex; justify-content:center; gap:15px;">
            <button class="cta-btn" onclick="document.getElementById('weather').scrollIntoView()">Check Weather</button>
            <button class="cta-btn" style="background:var(--white); color:var(--dark); border:1px solid #ccc;" onclick="document.getElementById('map').scrollIntoView()">View Radar</button>
        </div>
    </header>

    <!-- WEATHER SECTION -->
    <section id="weather" class="section">
        <h2 class="section-title">Real-Time Climate Analysis</h2>
        <div class="weather-card">
            <div class="search-box">
                <input type="text" id="cityInput" class="search-input" placeholder="Enter City Name (e.g., Kathmandu)">
                <button class="action-btn" onclick="getWeather()"><i class="fas fa-search"></i></button>
            </div>
            
            <div id="weather-placeholder" style="color:#94a3b8;">
                <i class="fas fa-cloud-sun" style="font-size: 3rem; margin-bottom:10px;"></i>
                <p>Search a city to see AI analysis.</p>
            </div>

            <div id="weatherResult" class="weather-info">
                <h3 id="cityName">KATHMANDU</h3>
                <div class="temp-display" id="tempVal">--°C</div>
                <p id="condition" style="color:#64748b;">Clear Sky</p>
                <div class="ai-badge"><i class="fas fa-robot"></i> <span id="aiAdvice">Analyzing...</span></div>
            </div>
        </div>
    </section>

    <!-- AI CHAT SECTION -->
    <section id="ai" class="section" style="background:#f1f5f9;">
        <h2 class="section-title">Climate Oracle AI</h2>
        <p style="text-align:center; margin-bottom:20px; color:#64748b;">Ask about farming, weather risks, or atmospheric data.</p>
        
        <div class="ai-container">
            <div class="chat-header">
                <span><i class="fas fa-brain"></i> Professional Assistant</span>
                <span style="font-size:0.8rem; opacity:0.8;">Powered by Gemini</span>
            </div>
            <div class="chat-box" id="chatBox">
                <div class="msg bot">Hello! I am your Climate Assistant. How can I help you today?</div>
            </div>
            <div class="input-area">
                <input type="text" id="userMsg" class="search-input" placeholder="Type your question..." onkeypress="handleEnter(event)">
                <button class="cta-btn" onclick="sendAiMessage()">Send</button>
            </div>
        </div>
    </section>

    <!-- MAP & FLIGHT RADAR SECTION -->
    <section id="map" class="section">
        <h2 class="section-title">Live Flight & Node Radar</h2>
        <p style="text-align:center; margin-bottom:20px; color:#64748b;">Real-time tracking of atmospheric monitoring flights and ground sensors.</p>
        
        <div class="map-wrapper">
            <div class="map-controls">
                <button onclick="toggleLayer('nodes')"><i class="fas fa-wifi"></i> Ground Nodes</button>
                <button onclick="toggleLayer('flights')" id="flightBtn" class="active"><i class="fas fa-plane"></i> Live Flights</button>
            </div>
            <div id="map"></div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer>
        <p>&copy; 2025 Climate Singularity Hyperverse.</p>
        <p style="font-size:0.8rem; color:#94a3b8; margin-top:10px;">Powered by Google Gemini, OpenWeatherMap & OpenSky Network</p>
    </footer>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. CONFIGURATION & KEYS ---
        const weatherKey = 'face30cd97a1b8feaaef06775dd83931';
        const geminiKey = 'AIzaSyDESfOpoo5WBnshXTgBJEwOrrP64j23VBM';

        // --- 2. MAP & FLIGHT RADAR LOGIC ---
        let map, flightLayer, nodeLayer;
        let flightsActive = true;

        function initMap() {
            // Initialize Map focused on Nepal
            map = L.map('map').setView([28.3949, 84.1240], 7);
            
            // Professional Map Tiles (CartoDB Voyager - Clean look)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(map);

            // Layer Groups
            flightLayer = L.layerGroup().addTo(map);
            nodeLayer = L.layerGroup().addTo(map);

            // Add Static Ground Nodes
            const nodes = [
                {lat: 27.7172, lng: 85.3240, name: "Kathmandu HQ"},
                {lat: 28.2096, lng: 83.9856, name: "Pokhara Station"},
                {lat: 27.6588, lng: 85.3247, name: "Lalitpur Sensor"},
                {lat: 26.4525, lng: 87.2718, name: "Biratnagar Hub"}
            ];

            const nodeIcon = L.divIcon({
                html: '<i class="fas fa-circle" style="color:#10b981; font-size:12px; text-shadow:0 0 5px #10b981;"></i>',
                className: 'node-icon'
            });

            nodes.forEach(n => {
                L.marker([n.lat, n.lng], {icon: nodeIcon})
                 .bindPopup(`<b>${n.name}</b><br>Status: Active<br>Data: Stable`)
                 .addTo(nodeLayer);
            });

            // Start Flight Tracking
            updateFlights();
            setInterval(updateFlights, 8000); // Update every 8 seconds
        }

        // Fetch Flights (Real + Simulation Fallback)
        async function updateFlights() {
            if (!flightsActive) return;

            // Clear old planes
            flightLayer.clearLayers();

            try {
                // Try fetching Real Data (OpenSky - Nepal Region)
                // Note: Free API has limits, so we handle errors gracefully
                const response = await fetch('https://opensky-network.org/api/states/all?lamin=26.0&lomin=80.0&lamax=30.5&lomax=88.5');
                const data = await response.json();

                if (data.states && data.states.length > 0) {
                    data.states.forEach(flight => {
                        addPlaneToMap(flight[6], flight[5], flight[10] || 0, flight[1] || "Unknown");
                    });
                } else {
                    throw new Error("No flights found");
                }
            } catch (e) {
                // Fallback: Simulate "Climate Drones" if API is busy/empty
                // This ensures the map never looks empty/broken
                console.log("Using Simulation Mode");
                const simulatedPlanes = [
                    {lat: 27.8, lng: 85.1, head: 45, call: "CSC-01"},
                    {lat: 28.1, lng: 84.2, head: 90, call: "CSC-02"},
                    {lat: 27.5, lng: 86.0, head: 270, call: "CSC-03"}
                ];
                
                simulatedPlanes.forEach(p => {
                    // Make them move slightly
                    p.lat += (Math.random() - 0.5) * 0.05;
                    p.lng += (Math.random() - 0.5) * 0.05;
                    addPlaneToMap(p.lat, p.lng, p.head, p.call);
                });
            }
        }

        function addPlaneToMap(lat, lng, heading, callsign) {
            const planeIcon = L.divIcon({
                html: `<i class="fas fa-plane" style="transform: rotate(${heading - 45}deg); color: #ef4444; font-size: 20px;"></i>`,
                className: 'plane-icon',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            L.marker([lat, lng], {icon: planeIcon})
             .bindPopup(`<b>Flight: ${callsign}</b><br>Type: Atmospheric Sensor<br>Alt: ~30,000ft`)
             .addTo(flightLayer);
        }

        function toggleLayer(type) {
            if(type === 'flights') {
                flightsActive = !flightsActive;
                if(flightsActive) {
                    document.getElementById('flightBtn').classList.add('active');
                    updateFlights();
                } else {
                    document.getElementById('flightBtn').classList.remove('active');
                    flightLayer.clearLayers();
                }
            }
        }

        // --- 3. WEATHER LOGIC ---
        async function getWeather() {
            const city = document.getElementById('cityInput').value;
            if(!city) return alert("Please enter a city name.");

            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&appid=${weatherKey}`);
                if(!res.ok) throw new Error("City not found");
                const data = await res.json();

                document.getElementById('weather-placeholder').style.display = 'none';
                document.getElementById('weatherResult').style.display = 'block';
                document.getElementById('cityName').innerText = data.name.toUpperCase();
                document.getElementById('tempVal').innerText = Math.round(data.main.temp) + "°C";
                document.getElementById('condition').innerText = data.weather[0].main;

                let advice = "Conditions are favorable.";
                if(data.main.temp > 30) advice = "Heat Alert: Shield crops.";
                if(data.weather[0].main.includes("Rain")) advice = "Rain Detected: Monitor drainage.";
                document.getElementById('aiAdvice').innerText = advice;

            } catch (err) { alert("City not found. Try again."); }
        }

        // --- 4. AI CHAT LOGIC ---
        async function sendAiMessage() {
            const input = document.getElementById('userMsg');
            const text = input.value.trim();
            if(!text) return;

            addChat(text, 'user');
            input.value = '';
            const loadingId = addChat("Thinking...", 'bot');

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `You are a helpful climate expert AI for Nepal. Answer briefly. Question: ${text}` }] }]
                    })
                });

                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                document.getElementById(loadingId).innerText = reply.replace(/\*/g, '');

            } catch (err) {
                // FALLBACK AI (If Google Fails)
                document.getElementById(loadingId).innerText = getBackupReply(text);
            }
        }

        function addChat(text, type) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.id = 'msg-' + Date.now();
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div.id;
        }

        function handleEnter(e) { if(e.key === 'Enter') sendAiMessage(); }

        function getBackupReply(text) {
            if(text.toLowerCase().includes('weather')) return "Please use the Weather Tool above for accuracy.";
            return "I am unable to connect to the cloud right now. Please try again later.";
        }

        // --- 5. INITIALIZE ---
        // PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); });
        }
        
        // Start Map
        initMap();

    </script>
</body>
</html>
