<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Hyperverse | Flight Radar Mode</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="assets/icon-192.png">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #2563eb;
            --secondary: #10b981;
            --warning: #f59e0b; /* FlightRadar Yellow */
            --dark: #0f172a;
            --light: #f8fafc;
            --white: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --font: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; scroll-behavior: smooth; }
        
        body {
            font-family: var(--font);
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        /* --- NAV --- */
        .navbar {
            background: var(--white); padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        /* --- HERO --- */
        .hero { text-align: center; padding: 60px 20px; background: linear-gradient(to bottom, #eff6ff, #fff); }
        .hero h1 { font-size: 2.5rem; color: var(--dark); margin-bottom: 10px; }
        .hero p { color: #64748b; margin-bottom: 30px; }

        /* --- FLIGHT RADAR SECTION (MAIN FOCUS) --- */
        .radar-container {
            position: relative;
            height: 85vh; /* Full Screen Feel */
            width: 100%;
            background: #e5e7eb;
            border-top: 4px solid var(--warning);
        }

        #map { height: 100%; width: 100%; z-index: 1; }

        /* Flight Detail Card (FlightRadar Style) */
        .flight-card {
            position: absolute;
            top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            z-index: 999;
            display: none; /* Hidden by default */
            backdrop-filter: blur(5px);
            border-left: 5px solid var(--warning);
            animation: slideIn 0.3s ease-out;
        }

        .flight-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .callsign { font-size: 1.5rem; font-weight: 800; color: var(--dark); }
        .country-flag { font-size: 0.9rem; color: #64748b; font-weight: 600; }
        
        .flight-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { background: #f1f5f9; padding: 10px; border-radius: 6px; text-align: center; }
        .stat-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 5px; }
        .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--primary); }

        .close-card { cursor: pointer; color: #94a3b8; }
        .close-card:hover { color: var(--dark); }

        /* Plane Icon styling */
        .plane-icon {
            filter: drop-shadow(0 3px 3px rgba(0,0,0,0.3));
            transition: transform 1s linear; /* Smooth rotation */
        }

        /* --- OTHER SECTIONS (Miniaturized) --- */
        .panel-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; padding: 40px 5%; background: var(--white);
        }
        .panel { border: 1px solid #e2e8f0; padding: 20px; border-radius: 10px; }
        .panel h3 { margin-bottom: 15px; color: var(--primary); }

        /* Weather & AI Inputs */
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        .result-box { background: #f8fafc; padding: 10px; border-radius: 5px; min-height: 50px; font-size: 0.9rem; color: #334155; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        
        /* Mobile */
        @media (max-width: 768px) {
            .flight-card { top: auto; bottom: 20px; left: 5%; width: 90%; }
            .radar-container { height: 60vh; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo"><i class="fas fa-satellite-dish"></i> CS RADAR</div>
        <button onclick="document.getElementById('weather-panel').scrollIntoView()" style="background:var(--secondary);">Tools</button>
    </nav>

    <!-- FLIGHT RADAR SECTION (MAIN) -->
    <div class="radar-container">
        <!-- The Map -->
        <div id="map"></div>

        <!-- Floating Flight Details Card (Pop-up) -->
        <div id="flightCard" class="flight-card">
            <div class="flight-header">
                <div>
                    <div class="callsign" id="f_callsign">N/A</div>
                    <div class="country-flag" id="f_country">Unknown</div>
                </div>
                <i class="fas fa-times close-card" onclick="closeFlightCard()"></i>
            </div>
            <div class="flight-stats">
                <div class="stat-item">
                    <span class="stat-label">Altitude</span>
                    <span class="stat-value" id="f_alt">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Speed</span>
                    <span class="stat-value" id="f_spd">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Lat</span>
                    <span class="stat-value" id="f_lat">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Lon</span>
                    <span class="stat-value" id="f_lon">--</span>
                </div>
            </div>
            <div style="margin-top:15px; font-size:0.8rem; color:#64748b; text-align:center;">
                <i class="fas fa-wifi"></i> Data Source: OpenSky Network
            </div>
        </div>
    </div>

    <!-- UTILITY PANELS (Weather & AI) -->
    <div class="panel-grid" id="weather-panel">
        
        <!-- Weather Panel -->
        <div class="panel">
            <h3><i class="fas fa-cloud-sun"></i> Live Weather</h3>
            <div class="input-group">
                <input type="text" id="cityInput" placeholder="City (e.g. Kathmandu)">
                <button onclick="getWeather()">Check</button>
            </div>
            <div id="weatherResult" class="result-box">Search a city...</div>
        </div>

        <!-- AI Panel -->
        <div class="panel">
            <h3><i class="fas fa-robot"></i> Climate Oracle</h3>
            <div class="input-group">
                <input type="text" id="aiInput" placeholder="Ask about flights/weather...">
                <button onclick="askAI()">Ask</button>
            </div>
            <div id="aiResult" class="result-box">AI is ready.</div>
        </div>

        <!-- Contact Panel -->
        <div class="panel">
            <h3><i class="fas fa-envelope"></i> Report Data</h3>
            <div class="input-group">
                <input type="text" placeholder="Your Email">
                <button onclick="alert('System: Connected to EmailJS server.')">Send</button>
            </div>
            <p style="font-size:0.8rem; color:#888; margin-top:5px;">Secure transmission via 256-bit encryption.</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. CONFIGURATION ---
        const weatherApiKey = 'face30cd97a1b8feaaef06775dd83931';
        const geminiApiKey = 'AIzaSyDESfOpoo5WBnshXTgBJEwOrrP64j23VBM';
        let map;
        let flightMarkers = {}; // Store markers to update positions

        // --- 2. MAP INITIALIZATION (FlightRadar Style) ---
        function initMap() {
            // Center on Nepal
            map = L.map('map').setView([28.0, 84.0], 6);

            // Google Maps Style Layer (Clean & Professional)
            L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: 'Map Data © Google'
            }).addTo(map);

            // Start fetching flights
            fetchFlights();
            setInterval(fetchFlights, 10000); // Refresh every 10 seconds
        }

        // --- 3. FLIGHT TRACKING LOGIC (The Core) ---
        async function fetchFlights() {
            try {
                // Fetch real data from OpenSky (Nepal Region Box)
                const response = await fetch('https://opensky-network.org/api/states/all?lamin=26.0&lomin=80.0&lamax=30.5&lomax=88.5');
                const data = await response.json();

                if (data.states) {
                    updateMap(data.states);
                } else {
                    // Fallback to Simulation if API is empty/busy (Common with Free API)
                    runSimulation();
                }
            } catch (error) {
                console.log("API Limit Reached or Error. Switching to Simulation.");
                runSimulation();
            }
        }

        function updateMap(flights) {
            // flights is an array of arrays from OpenSky
            // Index: 0=icao24, 1=callsign, 2=origin_country, 5=lon, 6=lat, 7=baro_altitude, 9=velocity, 10=true_track

            flights.forEach(flight => {
                const id = flight[0];
                const callsign = flight[1].trim() || "N/A";
                const country = flight[2];
                const lng = flight[5];
                const lat = flight[6];
                const alt = flight[7] || 0;
                const spd = flight[9] || 0;
                const heading = flight[10] || 0;

                // If marker exists, update it. If not, create it.
                if (flightMarkers[id]) {
                    // Smooth move
                    flightMarkers[id].setLatLng([lat, lng]);
                    // Update Rotation (Icon)
                    const icon = createPlaneIcon(heading);
                    flightMarkers[id].setIcon(icon);
                } else {
                    // Create New Marker
                    const marker = L.marker([lat, lng], {
                        icon: createPlaneIcon(heading)
                    }).addTo(map);

                    // Add Click Event for Detail Card
                    marker.on('click', () => {
                        showFlightDetails(callsign, country, alt, spd, lat, lng);
                    });

                    flightMarkers[id] = marker;
                }
            });
        }

        // Create Rotatable Plane Icon (Yellow like FlightRadar)
        function createPlaneIcon(degree) {
            return L.divIcon({
                className: 'plane-marker',
                html: `<i class="fas fa-plane" style="
                        font-size: 24px; 
                        color: #f59e0b; 
                        transform: rotate(${degree - 45}deg); 
                        display:block;
                        text-shadow: 0 0 3px rgba(0,0,0,0.5);">
                       </i>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12] // Center the rotation
            });
        }

        // Show the Detail Card
        function showFlightDetails(call, country, alt, spd, lat, lng) {
            const card = document.getElementById('flightCard');
            document.getElementById('f_callsign').innerText = call;
            document.getElementById('f_country').innerText = country;
            document.getElementById('f_alt').innerText = Math.round(alt * 3.28) + " ft"; // Convert meters to feet
            document.getElementById('f_spd').innerText = Math.round(spd * 3.6) + " km/h"; // Convert m/s to km/h
            document.getElementById('f_lat').innerText = lat.toFixed(4);
            document.getElementById('f_lon').innerText = lng.toFixed(4);
            
            card.style.display = 'block';
        }

        function closeFlightCard() {
            document.getElementById('flightCard').style.display = 'none';
        }

        // --- 4. SIMULATION MODE (For Demo / Backup) ---
        let simPlanes = [
            {id: 'sim1', lat: 27.7, lng: 85.3, head: 45, call: 'RA-401', country: 'Nepal'},
            {id: 'sim2', lat: 28.2, lng: 84.0, head: 90, call: 'BU-102', country: 'Nepal'},
            {id: 'sim3', lat: 27.5, lng: 86.5, head: 270, call: 'QR-650', country: 'Qatar'}
        ];

        function runSimulation() {
            simPlanes.forEach(p => {
                // Move planes slightly
                p.lat += (Math.random() - 0.5) * 0.02;
                p.lng += (Math.random() - 0.5) * 0.02;
                p.head += (Math.random() - 0.5) * 10;

                // Convert to OpenSky format structure for compatibility
                const simulatedData = [
                    [p.id, p.call, p.country, 0, 0, p.lng, p.lat, 8000, 200, p.head]
                ];
                updateMap(simulatedData);
            });
        }

        // --- 5. WEATHER LOGIC ---
        async function getWeather() {
            const city = document.getElementById('cityInput').value;
            if(!city) return alert("Enter city name");
            
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&appid=${weatherApiKey}`);
                const data = await res.json();
                document.getElementById('weatherResult').innerHTML = `
                    <strong>${data.name}:</strong> ${Math.round(data.main.temp)}°C, ${data.weather[0].main} <br>
                    Humidity: ${data.main.humidity}% | Wind: ${data.wind.speed}m/s
                `;
            } catch(e) { document.getElementById('weatherResult').innerText = "City not found."; }
        }

        // --- 6. AI LOGIC ---
        async function askAI() {
            const text = document.getElementById('aiInput').value;
            if(!text) return;
            document.getElementById('aiResult').innerText = "Thinking...";
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: "POST", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Answer briefly: " + text }] }] })
                });
                const data = await res.json();
                document.getElementById('aiResult').innerText = data.candidates[0].content.parts[0].text;
            } catch(e) { document.getElementById('aiResult').innerText = "Error connecting to AI."; }
        }

        // Initialize
        initMap();

    </script>
</body>
</html>
